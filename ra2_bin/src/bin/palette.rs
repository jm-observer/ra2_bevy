//! A simple 3D scene with light shining over a cube sitting on a plane.

use bevy::prelude::*;
use ra2_asset::{asset::PaletteAsset, loader::PaletteLoader};
use ra2_data::lighting::Lighting;
use ra2_render::iso_palettes::IsoPalettes;
use std::env;

fn main() {
    env::set_var("BEVY_ASSET_ROOT", "D:\\git");
    App::new()
        .add_plugins(DefaultPlugins)
        .add_asset::<PaletteAsset>()
        .add_asset_loader(PaletteLoader)
        .add_systems(Startup, setup)
        .add_systems(Update, print_on_load)
        .run();
}

/// set up a simple 3D scenew
fn setup(mut commands: Commands, assert_server: ResMut<AssetServer>) {
    let palette = assert_server.load("palettes/isotem.pal");
    commands.insert_resource(CustomRes {
        palette,
        printed: false
    });
    commands.spawn(Camera2dBundle::default());
}

fn print_on_load(mut state: ResMut<CustomRes>, palette_assets: ResMut<Assets<PaletteAsset>>) {
    if state.printed {
        return;
    }

    let palette_asset = palette_assets.get(&state.palette);
    let Some(palette) = palette_asset else {
        return;
    };
    let lighting = mp02t2_lighting();

    let palettes = IsoPalettes::new(palette.datas.as_slice(), &lighting);

    for (index, color) in palettes.palettes[0].colors.into_iter().enumerate() {
        if !(color.r == LEVEL0[index][0]
            && color.g == LEVEL0[index][1]
            && color.b == LEVEL0[index][2])
        {
            println!(
                "error at 0.{}: {}\t{}\t{}",
                index, color.r, color.g, color.b
            );
        }
    }
    for (index, color) in palettes.palettes[1].colors.into_iter().enumerate() {
        if !(color.r == LEVEL1[index][0]
            && color.g == LEVEL1[index][1]
            && color.b == LEVEL1[index][2])
        {
            println!(
                "error at 1.{}: {}\t{}\t{}",
                index, color.r, color.g, color.b
            );
        }
    }
    println!("all right");
    state.printed = true;
}

#[derive(Resource)]
pub struct CustomRes {
    pub palette: Handle<PaletteAsset>,
    pub printed: bool
}

fn mp02t2_lighting() -> Lighting {
    Lighting {
        level:      0.008,
        ambient:    0.85,
        red:        1.0,
        green:      1.0,
        blue:       1.10,
        ground:     0.0,
        force_tint: true
    }
}

const LEVEL1: [[u8; 3]; 256] = [
    [0, 0, 118],
    [0, 218, 240],
    [0, 156, 141],
    [27, 194, 84],
    [218, 0, 0],
    [218, 218, 0],
    [0, 218, 0],
    [0, 114, 0],
    [0, 180, 0],
    [0, 187, 206],
    [218, 0, 240],
    [0, 114, 240],
    [0, 107, 233],
    [0, 0, 240],
    [0, 0, 198],
    [79, 215, 206],
    [191, 135, 236],
    [184, 83, 206],
    [107, 0, 126],
    [218, 0, 145],
    [138, 0, 91],
    [184, 194, 191],
    [184, 187, 206],
    [166, 187, 183],
    [180, 177, 191],
    [218, 191, 129],
    [218, 180, 103],
    [215, 173, 122],
    [204, 177, 141],
    [215, 170, 103],
    [131, 41, 171],
    [204, 173, 118],
    [194, 173, 145],
    [197, 177, 99],
    [204, 170, 103],
    [204, 173, 80],
    [197, 170, 126],
    [166, 170, 187],
    [211, 163, 99],
    [208, 163, 106],
    [201, 163, 122],
    [191, 170, 103],
    [197, 163, 103],
    [218, 156, 76],
    [187, 163, 126],
    [201, 163, 76],
    [211, 152, 99],
    [173, 152, 198],
    [197, 166, 49],
    [194, 156, 99],
    [184, 163, 99],
    [184, 156, 122],
    [170, 156, 160],
    [152, 159, 171],
    [215, 142, 80],
    [218, 142, 68],
    [187, 156, 76],
    [218, 142, 61],
    [194, 145, 99],
    [145, 163, 152],
    [177, 152, 103],
    [177, 145, 118],
    [156, 163, 80],
    [156, 159, 95],
    [184, 142, 80],
    [156, 156, 80],
    [156, 159, 68],
    [145, 145, 160],
    [194, 138, 49],
    [191, 138, 61],
    [187, 138, 68],
    [173, 138, 99],
    [177, 121, 179],
    [145, 145, 137],
    [152, 149, 80],
    [152, 152, 57],
    [201, 125, 72],
    [156, 142, 103],
    [156, 142, 91],
    [204, 121, 61],
    [152, 145, 68],
    [142, 145, 84],
    [135, 152, 68],
    [104, 156, 15],
    [204, 118, 49],
    [177, 128, 80],
    [152, 138, 80],
    [142, 135, 141],
    [135, 149, 57],
    [128, 145, 91],
    [34, 191, 87],
    [128, 145, 76],
    [142, 138, 61],
    [145, 138, 49],
    [149, 125, 95],
    [138, 135, 84],
    [128, 128, 137],
    [187, 114, 49],
    [177, 114, 72],
    [138, 121, 129],
    [149, 125, 80],
    [131, 138, 68],
    [177, 114, 61],
    [149, 125, 64],
    [170, 114, 53],
    [118, 138, 61],
    [111, 131, 118],
    [118, 135, 87],
    [118, 121, 133],
    [118, 138, 53],
    [121, 121, 122],
    [159, 114, 42],
    [83, 121, 0],
    [149, 114, 53],
    [131, 121, 68],
    [118, 125, 99],
    [152, 111, 68],
    [41, 128, 0],
    [131, 121, 61],
    [121, 125, 80],
    [184, 97, 45],
    [114, 125, 64],
    [128, 104, 122],
    [121, 118, 53],
    [111, 114, 122],
    [97, 125, 103],
    [166, 93, 53],
    [97, 121, 91],
    [118, 107, 99],
    [121, 111, 61],
    [118, 111, 72],
    [166, 90, 42],
    [149, 93, 64],
    [149, 93, 45],
    [97, 111, 95],
    [118, 104, 45],
    [90, 107, 95],
    [118, 100, 53],
    [114, 97, 80],
    [100, 97, 118],
    [90, 107, 84],
    [121, 100, 34],
    [97, 97, 106],
    [83, 107, 91],
    [90, 107, 57],
    [145, 79, 49],
    [79, 121, 3],
    [114, 86, 80],
    [145, 76, 34],
    [93, 90, 103],
    [118, 83, 61],
    [93, 93, 91],
    [121, 79, 49],
    [83, 93, 84],
    [90, 90, 72],
    [83, 90, 95],
    [76, 93, 84],
    [93, 90, 45],
    [118, 76, 34],
    [76, 86, 95],
    [76, 83, 84],
    [3, 118, 84],
    [72, 86, 68],
    [69, 86, 87],
    [79, 104, 19],
    [118, 65, 49],
    [79, 76, 87],
    [90, 69, 57],
    [79, 72, 76],
    [69, 76, 95],
    [69, 76, 84],
    [69, 76, 76],
    [59, 90, 19],
    [114, 59, 34],
    [76, 72, 64],
    [86, 69, 42],
    [69, 69, 84],
    [69, 69, 76],
    [62, 69, 84],
    [83, 69, 26],
    [69, 69, 68],
    [69, 69, 57],
    [62, 69, 76],
    [0, 83, 42],
    [62, 72, 68],
    [62, 65, 95],
    [55, 69, 84],
    [62, 62, 84],
    [62, 62, 76],
    [55, 62, 95],
    [69, 55, 91],
    [62, 62, 68],
    [59, 65, 49],
    [55, 62, 84],
    [55, 62, 76],
    [0, 76, 53],
    [76, 55, 49],
    [55, 62, 64],
    [0, 72, 49],
    [65, 83, 0],
    [48, 65, 84],
    [59, 65, 26],
    [55, 55, 95],
    [83, 52, 34],
    [65, 55, 64],
    [38, 69, 3],
    [55, 55, 84],
    [55, 55, 76],
    [55, 55, 68],
    [55, 55, 61],
    [48, 55, 87],
    [45, 65, 34],
    [55, 55, 49],
    [48, 55, 76],
    [13, 59, 0],
    [3, 59, 3],
    [69, 45, 49],
    [55, 48, 84],
    [48, 55, 64],
    [48, 55, 53],
    [55, 45, 76],
    [55, 48, 61],
    [48, 48, 87],
    [55, 52, 34],
    [48, 48, 76],
    [52, 55, 19],
    [48, 52, 45],
    [48, 48, 68],
    [55, 45, 49],
    [48, 48, 61],
    [48, 48, 53],
    [72, 38, 30],
    [38, 45, 61],
    [41, 45, 53],
    [48, 41, 45],
    [41, 45, 42],
    [31, 41, 76],
    [38, 45, 19],
    [31, 41, 49],
    [6, 62, 0],
    [52, 34, 34],
    [38, 34, 38],
    [34, 34, 45],
    [20, 41, 7],
    [38, 27, 38],
    [24, 31, 42],
    [31, 27, 30],
    [31, 20, 30],
    [31, 20, 19],
    [17, 20, 22],
    [10, 17, 3],
    [10, 0, 7],
    [0, 0, 0],
    [201, 201, 217],
    [215, 218, 233],
    [218, 218, 240]
];

const LEVEL0: [[u8; 3]; 256] = [
    [0, 0, 117],
    [0, 216, 238],
    [0, 154, 140],
    [27, 192, 83],
    [216, 0, 0],
    [216, 216, 0],
    [0, 216, 0],
    [0, 113, 0],
    [0, 178, 0],
    [0, 185, 204],
    [216, 0, 238],
    [0, 113, 238],
    [0, 106, 230],
    [0, 0, 238],
    [0, 0, 196],
    [79, 213, 204],
    [189, 134, 234],
    [182, 82, 204],
    [106, 0, 124],
    [216, 0, 143],
    [137, 0, 90],
    [182, 192, 189],
    [182, 185, 204],
    [165, 185, 181],
    [178, 175, 189],
    [216, 189, 128],
    [216, 178, 102],
    [213, 172, 121],
    [202, 175, 140],
    [213, 168, 102],
    [130, 41, 170],
    [202, 172, 117],
    [192, 172, 143],
    [196, 175, 98],
    [202, 168, 102],
    [202, 172, 79],
    [196, 168, 124],
    [165, 168, 185],
    [209, 161, 98],
    [206, 161, 105],
    [199, 161, 121],
    [189, 168, 102],
    [196, 161, 102],
    [216, 154, 75],
    [185, 161, 124],
    [199, 161, 75],
    [209, 151, 98],
    [172, 151, 196],
    [196, 165, 49],
    [192, 154, 98],
    [182, 161, 98],
    [182, 154, 121],
    [168, 154, 158],
    [151, 158, 170],
    [213, 141, 79],
    [216, 141, 68],
    [185, 154, 75],
    [216, 141, 60],
    [192, 144, 98],
    [144, 161, 151],
    [175, 151, 102],
    [175, 144, 117],
    [154, 161, 79],
    [154, 158, 94],
    [182, 141, 79],
    [154, 154, 79],
    [154, 158, 68],
    [144, 144, 158],
    [192, 137, 49],
    [189, 137, 60],
    [185, 137, 68],
    [172, 137, 98],
    [175, 120, 177],
    [144, 144, 136],
    [151, 147, 79],
    [151, 151, 56],
    [199, 123, 71],
    [154, 141, 102],
    [154, 141, 90],
    [202, 120, 60],
    [151, 144, 68],
    [141, 144, 83],
    [134, 151, 68],
    [103, 154, 15],
    [202, 116, 49],
    [175, 127, 79],
    [151, 137, 79],
    [141, 134, 140],
    [134, 147, 56],
    [127, 144, 90],
    [34, 189, 87],
    [127, 144, 75],
    [141, 137, 60],
    [144, 137, 49],
    [147, 123, 94],
    [137, 134, 83],
    [127, 127, 136],
    [185, 113, 49],
    [175, 113, 71],
    [137, 120, 128],
    [147, 123, 79],
    [130, 137, 68],
    [175, 113, 60],
    [147, 123, 64],
    [168, 113, 52],
    [116, 137, 60],
    [110, 130, 117],
    [116, 134, 87],
    [116, 120, 132],
    [116, 137, 52],
    [120, 120, 121],
    [158, 113, 41],
    [82, 120, 0],
    [147, 113, 52],
    [130, 120, 68],
    [116, 123, 98],
    [151, 110, 68],
    [41, 127, 0],
    [130, 120, 60],
    [120, 123, 79],
    [182, 96, 45],
    [113, 123, 64],
    [127, 103, 121],
    [120, 116, 52],
    [110, 113, 121],
    [96, 123, 102],
    [165, 92, 52],
    [96, 120, 90],
    [116, 106, 98],
    [120, 110, 60],
    [116, 110, 71],
    [165, 89, 41],
    [147, 92, 64],
    [147, 92, 45],
    [96, 110, 94],
    [116, 103, 45],
    [89, 106, 94],
    [116, 99, 52],
    [113, 96, 79],
    [99, 96, 117],
    [89, 106, 83],
    [120, 99, 34],
    [96, 96, 105],
    [82, 106, 90],
    [89, 106, 56],
    [144, 79, 49],
    [79, 120, 3],
    [113, 86, 79],
    [144, 75, 34],
    [92, 89, 102],
    [116, 82, 60],
    [92, 92, 90],
    [120, 79, 49],
    [82, 92, 83],
    [89, 89, 71],
    [82, 89, 94],
    [75, 92, 83],
    [92, 89, 45],
    [116, 75, 34],
    [75, 86, 94],
    [75, 82, 83],
    [3, 116, 83],
    [72, 86, 68],
    [68, 86, 87],
    [79, 103, 18],
    [116, 65, 49],
    [79, 75, 87],
    [89, 68, 56],
    [79, 72, 75],
    [68, 75, 94],
    [68, 75, 83],
    [68, 75, 75],
    [58, 89, 18],
    [113, 58, 34],
    [75, 72, 64],
    [86, 68, 41],
    [68, 68, 83],
    [68, 68, 75],
    [61, 68, 83],
    [82, 68, 26],
    [68, 68, 68],
    [68, 68, 56],
    [61, 68, 75],
    [0, 82, 41],
    [61, 72, 68],
    [61, 65, 94],
    [55, 68, 83],
    [61, 61, 83],
    [61, 61, 75],
    [55, 61, 94],
    [68, 55, 90],
    [61, 61, 68],
    [58, 65, 49],
    [55, 61, 83],
    [55, 61, 75],
    [0, 75, 52],
    [75, 55, 49],
    [55, 61, 64],
    [0, 72, 49],
    [65, 82, 0],
    [48, 65, 83],
    [58, 65, 26],
    [55, 55, 94],
    [82, 51, 34],
    [65, 55, 64],
    [37, 68, 3],
    [55, 55, 83],
    [55, 55, 75],
    [55, 55, 68],
    [55, 55, 60],
    [48, 55, 87],
    [44, 65, 34],
    [55, 55, 49],
    [48, 55, 75],
    [13, 58, 0],
    [3, 58, 3],
    [68, 44, 49],
    [55, 48, 83],
    [48, 55, 64],
    [48, 55, 52],
    [55, 44, 75],
    [55, 48, 60],
    [48, 48, 87],
    [55, 51, 34],
    [48, 48, 75],
    [51, 55, 18],
    [48, 51, 45],
    [48, 48, 68],
    [55, 44, 49],
    [48, 48, 60],
    [48, 48, 52],
    [72, 37, 30],
    [37, 44, 60],
    [41, 44, 52],
    [48, 41, 45],
    [41, 44, 41],
    [30, 41, 75],
    [37, 44, 18],
    [30, 41, 49],
    [6, 61, 0],
    [51, 34, 34],
    [37, 34, 37],
    [34, 34, 45],
    [20, 41, 7],
    [37, 27, 37],
    [24, 30, 41],
    [30, 27, 30],
    [30, 20, 30],
    [30, 20, 18],
    [17, 20, 22],
    [10, 17, 3],
    [10, 0, 7],
    [0, 0, 0],
    [199, 199, 215],
    [213, 216, 230],
    [216, 216, 238]
];
